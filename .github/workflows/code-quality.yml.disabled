# ä»£ç è´¨é‡æ£€æŸ¥æµæ°´çº¿
# åŒ…å«ESLintã€Prettierã€TypeScriptæ£€æŸ¥ã€å®‰å…¨æ‰«æç­‰

name: Code Quality

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'

jobs:
  # ESLint å’Œ Prettier æ£€æŸ¥
  lint-and-format:
    name: ä»£ç è§„èŒƒæ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´çš„gitå†å²ï¼Œç”¨äºå¢é‡æ£€æŸ¥
        fetch-depth: 0

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    # åç«¯ä»£ç æ£€æŸ¥
    - name: å®‰è£…åç«¯ä¾èµ–
      run: |
        cd backend
        npm ci

    - name: åç«¯ ESLint æ£€æŸ¥
      run: |
        cd backend
        npm run lint -- --format=json --output-file=eslint-report.json
        npm run lint -- --format=compact
      continue-on-error: true

    - name: åç«¯ Prettier æ£€æŸ¥
      run: |
        cd backend
        npm run format:check || (echo "ä»£ç æ ¼å¼ä¸ç¬¦åˆPrettierè§„èŒƒ" && exit 1)

    # å‰ç«¯ä»£ç æ£€æŸ¥  
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: |
        cd frontend
        npm ci

    - name: å‰ç«¯ ESLint æ£€æŸ¥
      run: |
        cd frontend
        npm run lint -- --format=json --output-file=eslint-report.json
        npm run lint -- --format=compact
      continue-on-error: true

    - name: å‰ç«¯ Prettier æ£€æŸ¥
      run: |
        cd frontend
        npm run format:check || (echo "ä»£ç æ ¼å¼ä¸ç¬¦åˆPrettierè§„èŒƒ" && exit 1)

    # æ±‡æ€»ä»£ç è´¨é‡æŠ¥å‘Š
    - name: ç”Ÿæˆä»£ç è´¨é‡æŠ¥å‘Š
      run: |
        echo "# ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š" > code-quality-report.md
        echo "## æ£€æŸ¥æ—¶é—´: $(date)" >> code-quality-report.md
        echo "" >> code-quality-report.md
        
        # æ£€æŸ¥ESLintæŠ¥å‘Š
        if [ -f backend/eslint-report.json ]; then
          echo "### åç«¯ESLintæ£€æŸ¥ç»“æœ" >> code-quality-report.md
          node -e "
            const report = require('./backend/eslint-report.json');
            const totalErrors = report.reduce((sum, file) => sum + file.errorCount, 0);
            const totalWarnings = report.reduce((sum, file) => sum + file.warningCount, 0);
            console.log(\`- é”™è¯¯æ•°é‡: \${totalErrors}\`);
            console.log(\`- è­¦å‘Šæ•°é‡: \${totalWarnings}\`);
          " >> code-quality-report.md
        fi
        
        if [ -f frontend/eslint-report.json ]; then
          echo "### å‰ç«¯ESLintæ£€æŸ¥ç»“æœ" >> code-quality-report.md
          node -e "
            const report = require('./frontend/eslint-report.json');
            const totalErrors = report.reduce((sum, file) => sum + file.errorCount, 0);
            const totalWarnings = report.reduce((sum, file) => sum + file.warningCount, 0);
            console.log(\`- é”™è¯¯æ•°é‡: \${totalErrors}\`);
            console.log(\`- è­¦å‘Šæ•°é‡: \${totalWarnings}\`);
          " >> code-quality-report.md
        fi

    - name: ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-report
        path: |
          code-quality-report.md
          backend/eslint-report.json
          frontend/eslint-report.json

    # å‘å¸ƒæ£€æŸ¥ç»“æœåˆ°PR
    - name: æ³¨é‡ŠPRç»“æœ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('code-quality-report.md')) {
            const report = fs.readFileSync('code-quality-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ä»£ç è´¨é‡æ£€æŸ¥ç»“æœ\n\n${report}`
            });
          }

  # TypeScript ç±»å‹æ£€æŸ¥
  type-check:
    name: TypeScript ç±»å‹æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: åç«¯ç±»å‹æ£€æŸ¥
      run: |
        cd backend
        npm ci
        npm run type-check 2>&1 | tee backend-type-check.log

    - name: å‰ç«¯ç±»å‹æ£€æŸ¥
      run: |
        cd frontend
        npm ci
        npm run type-check 2>&1 | tee frontend-type-check.log

    - name: ä¸Šä¼ ç±»å‹æ£€æŸ¥ç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: type-check-results
        path: |
          backend-type-check.log
          frontend-type-check.log

  # ä¾èµ–é¡¹å®‰å…¨æ£€æŸ¥
  dependency-security:
    name: ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    # æ£€æŸ¥å·²çŸ¥æ¼æ´
    - name: npm audit å®‰å…¨æ£€æŸ¥
      run: |
        echo "## åç«¯ä¾èµ–å®‰å…¨æ£€æŸ¥" > security-report.md
        cd backend
        npm audit --audit-level=moderate --json > ../backend-audit.json || true
        npm audit --audit-level=moderate >> ../security-report.md || true
        
        echo "## å‰ç«¯ä¾èµ–å®‰å…¨æ£€æŸ¥" >> ../security-report.md
        cd ../frontend
        npm audit --audit-level=moderate --json > ../frontend-audit.json || true
        npm audit --audit-level=moderate >> ../security-report.md || true

    # æ£€æŸ¥è¿‡æ—¶ä¾èµ–
    - name: æ£€æŸ¥è¿‡æ—¶ä¾èµ–
      run: |
        echo "## è¿‡æ—¶ä¾èµ–æ£€æŸ¥" >> security-report.md
        
        echo "### åç«¯è¿‡æ—¶ä¾èµ–" >> security-report.md
        cd backend
        npm outdated >> ../security-report.md || echo "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„" >> ../security-report.md
        
        echo "### å‰ç«¯è¿‡æ—¶ä¾èµ–" >> ../security-report.md
        cd ../frontend
        npm outdated >> ../security-report.md || echo "æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°çš„" >> ../security-report.md

    # è®¸å¯è¯æ£€æŸ¥
    - name: æ£€æŸ¥ä¾èµ–è®¸å¯è¯
      run: |
        npm install -g license-checker
        
        echo "## ä¾èµ–è®¸å¯è¯æ£€æŸ¥" >> security-report.md
        
        echo "### åç«¯ä¾èµ–è®¸å¯è¯" >> security-report.md
        cd backend
        license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC' --summary >> ../security-report.md || true
        
        echo "### å‰ç«¯ä¾èµ–è®¸å¯è¯" >> ../security-report.md
        cd ../frontend  
        license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC' --summary >> ../security-report.md || true

    - name: ä¸Šä¼ å®‰å…¨æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          security-report.md
          backend-audit.json
          frontend-audit.json

  # ä»£ç å¤æ‚åº¦åˆ†æ
  complexity-analysis:
    name: ä»£ç å¤æ‚åº¦åˆ†æ
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: å®‰è£…åˆ†æå·¥å…·
      run: |
        npm install -g complexity-report madge jscpd

    - name: åç«¯å¤æ‚åº¦åˆ†æ
      run: |
        cd backend
        npm ci
        
        echo "# åç«¯ä»£ç å¤æ‚åº¦åˆ†ææŠ¥å‘Š" > ../complexity-report.md
        echo "## å¾ªç¯å¤æ‚åº¦åˆ†æ" >> ../complexity-report.md
        
        # åˆ†æsrcç›®å½•çš„å¤æ‚åº¦
        find src -name "*.ts" -not -path "*/test/*" -not -name "*.spec.ts" | head -10 | while read file; do
          echo "### $file" >> ../complexity-report.md
          complexity-report --format json "$file" 2>/dev/null | jq -r '.reports[0] | "- å¤æ‚åº¦: \(.complexity.cyclomatic)"' >> ../complexity-report.md || echo "- æ— æ³•åˆ†æ" >> ../complexity-report.md
        done

    - name: å‰ç«¯å¤æ‚åº¦åˆ†æ
      run: |
        cd frontend
        npm ci
        
        echo "## å‰ç«¯ä»£ç å¤æ‚åº¦åˆ†æ" >> ../complexity-report.md
        
        # åˆ†æsrcç›®å½•çš„å¤æ‚åº¦
        find src -name "*.tsx" -o -name "*.ts" | head -10 | while read file; do
          echo "### $file" >> ../complexity-report.md
          complexity-report --format json "$file" 2>/dev/null | jq -r '.reports[0] | "- å¤æ‚åº¦: \(.complexity.cyclomatic)"' >> ../complexity-report.md || echo "- æ— æ³•åˆ†æ" >> ../complexity-report.md
        done

    # ä¾èµ–å…³ç³»åˆ†æ
    - name: ä¾èµ–å…³ç³»åˆ†æ
      run: |
        echo "## æ¨¡å—ä¾èµ–å…³ç³»åˆ†æ" >> complexity-report.md
        
        cd backend
        echo "### åç«¯æ¨¡å—ä¾èµ–" >> ../complexity-report.md
        madge --circular src/ >> ../complexity-report.md || echo "æœªå‘ç°å¾ªç¯ä¾èµ–" >> ../complexity-report.md
        
        cd ../frontend
        echo "### å‰ç«¯æ¨¡å—ä¾èµ–" >> ../complexity-report.md
        madge --circular src/ >> ../complexity-report.md || echo "æœªå‘ç°å¾ªç¯ä¾èµ–" >> ../complexity-report.md

    # ä»£ç é‡å¤åˆ†æ
    - name: ä»£ç é‡å¤åˆ†æ
      run: |
        echo "## ä»£ç é‡å¤åˆ†æ" >> complexity-report.md
        
        echo "### åç«¯ä»£ç é‡å¤" >> complexity-report.md
        jscpd backend/src --threshold 10 --format table >> complexity-report.md || echo "æœªå‘ç°æ˜¾è‘—ä»£ç é‡å¤" >> complexity-report.md
        
        echo "### å‰ç«¯ä»£ç é‡å¤" >> complexity-report.md
        jscpd frontend/src --threshold 10 --format table >> complexity-report.md || echo "æœªå‘ç°æ˜¾è‘—ä»£ç é‡å¤" >> complexity-report.md

    - name: ä¸Šä¼ å¤æ‚åº¦åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: complexity-analysis
        path: complexity-report.md

  # SonarQube ä»£ç è´¨é‡åˆ†æ (å¯é€‰)
  sonarqube-analysis:
    name: SonarQube åˆ†æ
    runs-on: ubuntu-latest
    if: false  # é»˜è®¤ç¦ç”¨ï¼Œéœ€è¦é…ç½®SonarQubeæœåŠ¡å™¨æ—¶å¯ç”¨

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: SonarQube æ‰«æ
      uses: sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        scanMetadataReportFile: .scannerwork/report-task.txt

  # ç”Ÿæˆè´¨é‡é—¨ç¦æŠ¥å‘Š
  quality-gate:
    name: è´¨é‡é—¨ç¦æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [lint-and-format, type-check, dependency-security, complexity-analysis]
    if: always()

    steps:
    - name: ä¸‹è½½æ‰€æœ‰åˆ†ææŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        path: quality-reports

    - name: è´¨é‡é—¨ç¦è¯„ä¼°
      id: quality-gate
      run: |
        echo "## ğŸ” ä»£ç è´¨é‡é—¨ç¦æŠ¥å‘Š" > quality-gate-report.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> quality-gate-report.md
        echo "" >> quality-gate-report.md
        
        # æ£€æŸ¥å„ä¸ªä½œä¸šçš„ç»“æœ
        LINT_STATUS="${{ needs.lint-and-format.result }}"
        TYPE_CHECK_STATUS="${{ needs.type-check.result }}"
        SECURITY_STATUS="${{ needs.dependency-security.result }}"
        COMPLEXITY_STATUS="${{ needs.complexity-analysis.result }}"
        
        # è´¨é‡é—¨ç¦è§„åˆ™
        QUALITY_SCORE=0
        
        if [ "$LINT_STATUS" = "success" ]; then
          echo "âœ… ä»£ç è§„èŒƒæ£€æŸ¥: é€šè¿‡" >> quality-gate-report.md
          QUALITY_SCORE=$((QUALITY_SCORE + 25))
        else
          echo "âŒ ä»£ç è§„èŒƒæ£€æŸ¥: å¤±è´¥" >> quality-gate-report.md
        fi
        
        if [ "$TYPE_CHECK_STATUS" = "success" ]; then
          echo "âœ… TypeScriptç±»å‹æ£€æŸ¥: é€šè¿‡" >> quality-gate-report.md
          QUALITY_SCORE=$((QUALITY_SCORE + 25))
        else
          echo "âŒ TypeScriptç±»å‹æ£€æŸ¥: å¤±è´¥" >> quality-gate-report.md
        fi
        
        if [ "$SECURITY_STATUS" = "success" ]; then
          echo "âœ… å®‰å…¨æ£€æŸ¥: é€šè¿‡" >> quality-gate-report.md
          QUALITY_SCORE=$((QUALITY_SCORE + 25))
        else
          echo "âŒ å®‰å…¨æ£€æŸ¥: å¤±è´¥" >> quality-gate-report.md
        fi
        
        if [ "$COMPLEXITY_STATUS" = "success" ]; then
          echo "âœ… å¤æ‚åº¦åˆ†æ: é€šè¿‡" >> quality-gate-report.md
          QUALITY_SCORE=$((QUALITY_SCORE + 25))
        else
          echo "âŒ å¤æ‚åº¦åˆ†æ: å¤±è´¥" >> quality-gate-report.md
        fi
        
        echo "" >> quality-gate-report.md
        echo "### ğŸ“Š è´¨é‡è¯„åˆ†: $QUALITY_SCORE/100" >> quality-gate-report.md
        
        # è®¾ç½®è´¨é‡é—¨ç¦é€šè¿‡æ ‡å‡†
        if [ $QUALITY_SCORE -ge 75 ]; then
          echo "### âœ… è´¨é‡é—¨ç¦: é€šè¿‡" >> quality-gate-report.md
          echo "quality-gate-passed=true" >> $GITHUB_OUTPUT
        else
          echo "### âŒ è´¨é‡é—¨ç¦: æœªé€šè¿‡" >> quality-gate-report.md
          echo "quality-gate-passed=false" >> $GITHUB_OUTPUT
        fi
        
        echo "quality-score=$QUALITY_SCORE" >> $GITHUB_OUTPUT

    - name: å‘å¸ƒè´¨é‡é—¨ç¦ç»“æœ
      run: |
        cat quality-gate-report.md >> $GITHUB_STEP_SUMMARY

    - name: è´¨é‡é—¨ç¦æ£€æŸ¥
      if: steps.quality-gate.outputs.quality-gate-passed == 'false'
      run: |
        echo "è´¨é‡é—¨ç¦æœªé€šè¿‡ï¼Œè´¨é‡è¯„åˆ†: ${{ steps.quality-gate.outputs.quality-score }}/100"
        echo "è¯·ä¿®å¤ä»£ç è´¨é‡é—®é¢˜åé‡æ–°æäº¤"
        exit 1

    - name: ä¸Šä¼ è´¨é‡é—¨ç¦æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-gate-report
        path: |
          quality-gate-report.md
          quality-reports/