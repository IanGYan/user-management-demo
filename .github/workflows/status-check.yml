# çŠ¶æ€æ£€æŸ¥å·¥ä½œæµ
# ç”¨äºéªŒè¯åŸºç¡€é¡¹ç›®å¥åº·åº¦çš„ç®€åŒ–æ£€æŸ¥

name: Status Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹è¿è¡Œå¥åº·æ£€æŸ¥
    - cron: '0 9 * * 1'

jobs:
  # å¿«é€Ÿå¥åº·æ£€æŸ¥
  health-check:
    name: é¡¹ç›®å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    # æ£€æŸ¥é¡¹ç›®ç»“æ„
    - name: éªŒè¯é¡¹ç›®ç»“æ„
      run: |
        echo "æ£€æŸ¥é¡¹ç›®ç»“æ„..."
        
        # å¿…éœ€çš„ç›®å½•å’Œæ–‡ä»¶
        required_files=(
          "backend/package.json"
          "frontend/package.json"
          "docker-compose.yml"
          ".github/workflows"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -e "$file" ]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°: $file"
          fi
        done

    # æ£€æŸ¥ä¾èµ–å®‰è£…
    - name: éªŒè¯ä¾èµ–å®‰è£…
      run: |
        echo "æ£€æŸ¥ä¾èµ–å®‰è£…..."
        
        cd backend
        if npm ci --silent; then
          echo "âœ… åç«¯ä¾èµ–å®‰è£…æˆåŠŸ"
        else
          echo "âŒ åç«¯ä¾èµ–å®‰è£…å¤±è´¥"
          exit 1
        fi
        
        cd ../frontend
        if npm ci --silent; then
          echo "âœ… å‰ç«¯ä¾èµ–å®‰è£…æˆåŠŸ"
        else
          echo "âŒ å‰ç«¯ä¾èµ–å®‰è£…å¤±è´¥"
          exit 1
        fi

    # å¿«é€Ÿè¯­æ³•æ£€æŸ¥
    - name: å¿«é€Ÿè¯­æ³•æ£€æŸ¥
      run: |
        echo "è¿›è¡Œå¿«é€Ÿè¯­æ³•æ£€æŸ¥..."
        
        cd backend
        if npm run lint:check > /dev/null 2>&1; then
          echo "âœ… åç«¯è¯­æ³•æ£€æŸ¥é€šè¿‡"
        else
          echo "âš ï¸ åç«¯å­˜åœ¨è¯­æ³•é—®é¢˜"
        fi
        
        cd ../frontend  
        if npm run lint > /dev/null 2>&1; then
          echo "âœ… å‰ç«¯è¯­æ³•æ£€æŸ¥é€šè¿‡"
        else
          echo "âš ï¸ å‰ç«¯å­˜åœ¨è¯­æ³•é—®é¢˜"
        fi

    # æ„å»ºæµ‹è¯•
    - name: éªŒè¯æ„å»º
      run: |
        echo "éªŒè¯é¡¹ç›®æ„å»º..."
        
        cd backend
        if npm run build; then
          echo "âœ… åç«¯æ„å»ºæˆåŠŸ"
        else
          echo "âŒ åç«¯æ„å»ºå¤±è´¥"
          exit 1
        fi
        
        cd ../frontend
        if npm run build; then
          echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"
        else
          echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥"
          exit 1
        fi

  # Docker æ„å»ºæ£€æŸ¥
  docker-health:
    name: Docker å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: éªŒè¯ Docker Compose
      run: |
        echo "éªŒè¯ Docker Compose é…ç½®..."
        
        # æ£€æŸ¥ docker-compose æ–‡ä»¶è¯­æ³•
        if docker-compose config > /dev/null 2>&1; then
          echo "âœ… docker-compose.yml è¯­æ³•æ­£ç¡®"
        else
          echo "âŒ docker-compose.yml è¯­æ³•é”™è¯¯"
          exit 1
        fi
        
        if [ -f docker-compose.prod.yml ]; then
          if docker-compose -f docker-compose.prod.yml config > /dev/null 2>&1; then
            echo "âœ… docker-compose.prod.yml è¯­æ³•æ­£ç¡®"
          else
            echo "âŒ docker-compose.prod.yml è¯­æ³•é”™è¯¯"
            exit 1
          fi
        fi

    - name: æµ‹è¯• Docker æ„å»º
      run: |
        echo "æµ‹è¯• Docker é•œåƒæ„å»º..."
        
        # ä»…æ„å»ºï¼Œä¸è¿è¡Œï¼Œä»¥èŠ‚çœæ—¶é—´
        if [ -f backend/Dockerfile ]; then
          docker build --no-cache -t test-backend ./backend || echo "âš ï¸ åç«¯ Docker æ„å»ºå¯èƒ½å­˜åœ¨é—®é¢˜"
        fi
        
        if [ -f frontend/Dockerfile ]; then
          docker build --no-cache -t test-frontend ./frontend || echo "âš ï¸ å‰ç«¯ Docker æ„å»ºå¯èƒ½å­˜åœ¨é—®é¢˜"
        fi

  # å®‰å…¨åŸºç¡€æ£€æŸ¥
  security-basics:
    name: åŸºç¡€å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
      run: |
        echo "æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æ³„éœ²..."
        
        # æ£€æŸ¥æ˜¯å¦æ„å¤–æäº¤äº†æ•æ„Ÿæ–‡ä»¶
        sensitive_patterns=(
          "\.env$"
          "\.env\.local$"
          "\.env\.production$"
          "id_rsa$"
          "id_dsa$"
          "\.pem$"
          "\.key$"
          "config\.json$"
        )
        
        found_sensitive=false
        for pattern in "${sensitive_patterns[@]}"; do
          if find . -name "$pattern" -not -path "*/node_modules/*" | grep -q .; then
            echo "âš ï¸ å‘ç°å¯èƒ½çš„æ•æ„Ÿæ–‡ä»¶: $pattern"
            found_sensitive=true
          fi
        done
        
        if [ "$found_sensitive" = false ]; then
          echo "âœ… æœªå‘ç°æ•æ„Ÿæ–‡ä»¶æ³„éœ²"
        fi

    - name: æ£€æŸ¥é»˜è®¤å‡­æ®
      run: |
        echo "æ£€æŸ¥é»˜è®¤å‡­æ®..."
        
        # æ£€æŸ¥å¸¸è§çš„é»˜è®¤å‡­æ®æ¨¡å¼
        if grep -r "password.*123456\|password.*admin\|password.*password" . --exclude-dir=node_modules --exclude-dir=.git || true; then
          echo "âš ï¸ å‘ç°å¯èƒ½çš„å¼±å‡­æ®"
        else
          echo "âœ… æœªå‘ç°æ˜æ˜¾çš„å¼±å‡­æ®"
        fi

  # ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
  status-report:
    name: ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [health-check, docker-health, security-basics]
    if: always()

    steps:
    - name: ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
      run: |
        echo "# ğŸ“Š é¡¹ç›®çŠ¶æ€æŠ¥å‘Š" > status-report.md
        echo "ç”Ÿæˆæ—¶é—´: $(date)" >> status-report.md
        echo "" >> status-report.md
        
        # æ£€æŸ¥å„ä½œä¸šçŠ¶æ€
        HEALTH_STATUS="${{ needs.health-check.result }}"
        DOCKER_STATUS="${{ needs.docker-health.result }}"
        SECURITY_STATUS="${{ needs.security-basics.result }}"
        
        echo "## æ£€æŸ¥ç»“æœ" >> status-report.md
        
        if [ "$HEALTH_STATUS" = "success" ]; then
          echo "- âœ… é¡¹ç›®å¥åº·æ£€æŸ¥: é€šè¿‡" >> status-report.md
        else
          echo "- âŒ é¡¹ç›®å¥åº·æ£€æŸ¥: å¤±è´¥" >> status-report.md
        fi
        
        if [ "$DOCKER_STATUS" = "success" ]; then
          echo "- âœ… Docker å¥åº·æ£€æŸ¥: é€šè¿‡" >> status-report.md
        else
          echo "- âš ï¸ Docker å¥åº·æ£€æŸ¥: éœ€è¦æ³¨æ„" >> status-report.md
        fi
        
        if [ "$SECURITY_STATUS" = "success" ]; then
          echo "- âœ… åŸºç¡€å®‰å…¨æ£€æŸ¥: é€šè¿‡" >> status-report.md
        else
          echo "- âš ï¸ åŸºç¡€å®‰å…¨æ£€æŸ¥: éœ€è¦æ³¨æ„" >> status-report.md
        fi
        
        echo "" >> status-report.md
        echo "## ğŸ“ˆ æ€»ä½“çŠ¶æ€" >> status-report.md
        
        if [ "$HEALTH_STATUS" = "success" ] && [ "$DOCKER_STATUS" = "success" ] && [ "$SECURITY_STATUS" = "success" ]; then
          echo "ğŸŸ¢ **é¡¹ç›®çŠ¶æ€è‰¯å¥½**" >> status-report.md
        elif [ "$HEALTH_STATUS" = "success" ]; then
          echo "ğŸŸ¡ **é¡¹ç›®åŸºæœ¬å¥åº·ï¼Œéƒ¨åˆ†æ£€æŸ¥éœ€è¦å…³æ³¨**" >> status-report.md
        else
          echo "ğŸ”´ **é¡¹ç›®å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦ç«‹å³å¤„ç†**" >> status-report.md
        fi

    - name: è¾“å‡ºçŠ¶æ€æŠ¥å‘Š
      run: |
        cat status-report.md >> $GITHUB_STEP_SUMMARY

    - name: ä¸Šä¼ çŠ¶æ€æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: project-status-report
        path: status-report.md